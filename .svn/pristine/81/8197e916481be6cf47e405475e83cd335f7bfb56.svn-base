<template>
  <div>
    <router-link :to="'/vote/target/targetadd/add'">
        <el-button v-if="permissionAdd" type="primary" class="AddVillageBtn"><i class="el-icon-edit"></i> 新增</el-button>
    </router-link>
    <div style="float: right;">
      <el-input v-model="name1" placeholder="请输入名称或编号" style="width: 200px; margin-right: 10px" clearable></el-input>
      <el-button slot="append" icon="el-icon-search" type="primary" @click="handleSearch" style="margin-left:10px;">搜索</el-button>
    </div>
    <el-table
      v-if="permissionShow"
      v-loading="loading"
      element-loading-text="拼命加载中"
      element-loading-spinner="el-icon-loading"
      element-loading-background="rgba(0, 0, 0, 0.8)"
      stripe
      border
      :data="tableData"
      style="width: 100%;margin-top:10px"
      height="500">
        <el-table-column
          prop="tl_number"
          label="编号"
          sortable
          align="center"
          min-width="90">
       </el-table-column>
       <el-table-column
          prop="tl_name"
          label="名称"
          sortable
          align="center"
          min-width="180">
       </el-table-column>
       <el-table-column
          prop="vl_name"
          label="所属活动名称"
          sortable
          align="center"
          min-width="200">
       </el-table-column>
       <el-table-column
          prop="tl_poll"
          label="票数"
          sortable
          align="center"
          min-width="160">
       </el-table-column>
       <el-table-column
        fixed="right"
        label="操作"
        min-width="200"
        align="center">
        <template slot-scope="scope">
            <router-link :to="'/vote/target/targetdetail/'+scope.row.tl_id">
                <el-button v-if="permissionDetail" type="text" size="small">查看</el-button>
            </router-link>
            <router-link :to="'/vote/target/targetedit/'+scope.row.tl_id">
                <el-button v-if="permissionEdit" type="text" size="small" style="margin-left:10px">编辑</el-button>
            </router-link>
            <el-button v-if="permissionDelete" @click="handleDelete(scope.row)" type="text" size="small" style="margin-left:10px">删除</el-button>
        </template>
        </el-table-column>
    </el-table>

    <!-- 分页 -->
    <div id="pagination">
      <el-pagination
        v-if="total!=0"
        background
        layout="prev, pager, next,total ,jumper"
        :total="total"
        @current-change="handleCurrentChange">
      </el-pagination>
    </div>
  </div>
</template>

<script>
// 引入接口
import api from '@/api/api.js'
// 获取token
import { getToken , removeToken } from '@/utils/auth'

export default {
  name: 'componentspage1',
  data() {
      return {
        // 权限按钮控制
        permissionShow : false,
        permissionAdd : false,
        permissionEdit : false,
        permissionDetail : false,
        permissionDelete : false,

        total : 0, // 总条数
        start : 0, // 默认为0
        limit : 10, // 默认为10
        id1 : '', // null或空查询全部
        name1 : '',

        loading : true,
        tableData : []
      }
  },
  methods: {
    getSubPermission() {
        this.$http.get(`${api.dev}/p/permission/getSub`,{params: {access_token: getToken(), p_id : this.$route.params.id}}).then(res => {
            if(res.body.code == 200) {
                res.body.content.forEach(item => {
                    if(item.p_name.indexOf('显示') > -1) {
                        this.permissionShow = true
                    }else if(item.p_name.indexOf('新建') > -1) {
                        this.permissionAdd = true;
                    }else if(item.p_name.indexOf('修改') > -1) {
                        this.permissionEdit = true
                    }else if(item.p_name.indexOf('查看') > -1) {
                        this.permissionDetail = true
                    }else if(item.p_name.indexOf('删除') > -1) {
                        this.permissionDelete = true;
                    }
                })
            }else if(res.body.code === 500) {
                this.$message({
                    message: res.body.msg,
                    type: 'error'
                });
                removeToken();
                setTimeout(function () {
                    window.location.href = '/stwhy';
                },2000) 
            }
        })
    },
    getInfo() {
        var formdata = new FormData();
        formdata.append('access_token',getToken());
        formdata.append('start',this.start);
        formdata.append('limit',this.limit);
        formdata.append('id1',this.id1);
        formdata.append('name1',this.name1);
        this.$http.post(`${api.dev}/p/vote/target/show`,formdata,{emulateJSON: true}).then(res => {
            if(res.body.code == 200) {
                this.tableData = res.body.content.records;
                this.total = res.body.content.total;
                this.loading = false;
            }else if(res.body.code == 500) {
                this.$message({
                    message: res.body.msg,
                    type: 'error'
                });
                removeToken();
                setTimeout(function () {
                    window.location.href = '/stwhy';
                },2000)
            }
        })
    },
    handleSearch() {
          this.loading = true;
          this.getInfo();
      },
    // 分页
    handleCurrentChange(val) {
        this.loading = true;
        this.start = 10 * (val - 1);
        this.getInfo();
    },
    // 删除操作
    handleDelete(row) {
        // console.log(row.tl_id);
        this.$confirm('此操作将永久删除该数据, 是否继续?', '提示', {
            // cancelButtonClass: 'btn-custom-cancel',
            confirmButtonText: '确定',
            cancelButtonText: '取消',
            type: 'warning'
        }).then(() => {
            this.loading = true;
            this.$http.post(`${api.dev}/p/vote/target/delete`,{access_token: getToken(), tl_id : row.tl_id},{emulateJSON:true}).then(res => {
                if(res.body.code == 200) {
                    this.$message({
                        message: '删除成功',
                        type: 'success'
                    });
                    this.getInfo();
                }else if(res.body.code == 500) {
                    this.$message({
                        message: res.body.msg,
                        type: 'error'
                    });
                }else if(res.body.code == 510) {
                    this.$message({
                        message: res.body.msg,
                        type: 'error'
                    });
                    removeToken();
                    setTimeout(function () {
                        window.location.href = '/stwhy';
                    },2000) 
                }
            })
        })
    }
  },
  created() {
      this.getSubPermission()
      this.getInfo()
  }
}
</script>

<style lang="stylus" scoped>
#pagination
  margin-top 10px
</style>
