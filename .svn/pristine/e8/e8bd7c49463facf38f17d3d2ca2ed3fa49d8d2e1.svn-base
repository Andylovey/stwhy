<template>
  <div>
      <el-table
        v-if="permissionShow"
        v-loading="loading"
        element-loading-text="拼命加载中"
        element-loading-spinner="el-icon-loading"
        element-loading-background="rgba(0, 0, 0, 0.8)"
        :data="tableData"
        stripe
        border
        style="width: 100%"
        height="500"
        header-row-style="height:40px"
        row-style="height:40px">
        <el-table-column
        prop="p_name"
        label="名称"
        sortable
        align="center"
        show-overflow-tooltip>
        </el-table-column>
        <el-table-column
        prop="p_key"
        label="标识"
        sortable
        align="center"
        show-overflow-tooltip>
        </el-table-column>
        <el-table-column
        prop="p_source"
        label="设备"
        sortable
        align="center"
        show-overflow-tooltip>
        </el-table-column>
      </el-table>

        <!-- 分页 -->
    <div id="pagination">
      <el-pagination
        background
        layout="prev, pager, next,total ,jumper"
        :total="total"
        @current-change="handleCurrentChange">
      </el-pagination>
    </div>
  </div>
</template>

<script>
// 引入接口
import api from '@/api/api.js'
// 获取token
import { getToken , removeToken } from '@/utils/auth'

export default {
  name: 'pagelayout',
  data() {
      return {
          permissionShow : false,
          permissionAdd : false,
          permissionEdit : false,
          permissionDetail : false,
          permissionDelete : false,
          permissionSearch : false,

          tableData : [],
          loading : true,  // 加载条
          total: 0, // 分页总条数
          start : 0 ,
          limit : 10,
      }
  },
  methods : {
      getSubPermission() {
        this.$http.get(`${api.dev}/p/permission/getSub`,{params:{access_token:getToken(), p_id: this.$route.params.id}}).then(res => {
            if(res.body.code == 200) {
                res.body.content.forEach(item => {
                    if(item.p_name.indexOf('显示') > -1) {
                       this.permissionShow = true;
                    }else if(item.p_name.indexOf('查看') > -1) {
                        this.permissionDetail = true
                    }else if(item.p_name.indexOf('修改') > -1) {
                        this.permissionEdit = true;
                    }else if(item.p_name.indexOf('删除') > -1) {
                        this.permissionDelete = true;
                    }else if(item.p_name.indexOf('新建') > -1) {
                        this.permissionAdd = true;
                    }else if(item.p_name.indexOf('查询') > -1) {
                        this.permissionSearch = true;
                    }
                })
            }else if(res.body.code == 500) {
                this.$message({
                    message: res.body.msg,
                    type: 'error'
                });
                removeToken();
                setTimeout(function () {
                    window.location.href = '/stwhy';
                },2000)
            }
        })
    },
      getInfo() {
          this.$http.get(`${api.dev}/p/main/page/show`,{params:{access_token:getToken(),start:this.start,limit:this.limit}}).then(res => {
              if(res.body.code == 200) {
                    res.body.content.records.forEach(item => {
                        if(item.p_source == 0) {
                            item.p_source = 'PC端'
                        }else {
                            item.p_source = '移动端'
                        }
                    })
                    this.tableData = res.body.content.records;
                    this.total = res.body.content.total
                    this.loading = false;
              }else if(res.body.code == 500) {
                    this.$message({
                        message : res.body.msg,
                        type : 'error'
                    })
              }else if(res.body.code == 510) {
                    this.$message({
                        message : res.body.msg,
                        type : 'error'
                    })
                    removeToken();
                    setTimeout(function () {
                            window.location.href = '/stwhy';
                    },2000)
              }
          })
      },
      // 分页
        handleCurrentChange(val) {
            this.loading = true;
            this.start = 10 * (val - 1);
            this.getInfo();
        },
  }, 
  created() {
      this.getInfo()
      this.getSubPermission()
  }
}
</script>

<style lang="stylus" scoped>

</style>
